<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of utl_run_batchjob</title>
  <meta name="keywords" content="utl_run_batchjob">
  <meta name="description" content="Internal: the actual processing function of bci_batchtrain.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">code</a> &gt; <a href="index.html">utils</a> &gt; utl_run_batchjob.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for code/utils&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>utl_run_batchjob

</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>Internal: the actual processing function of bci_batchtrain.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function results = utl_run_batchjob(opts,d,appname,setnames) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Internal: the actual processing function of bci_batchtrain.
 Results = ult_run_batchjob(Options,DatasetIndex,ApproachName,DatasetNames)

 This function executes one of the individual jobs generated by bci_batchtrain (application of one
 approach to one dataset).

 In:
   Options : bci_batchtrain options struct

   DatasetIndex : index into Options.datasets that determines which dataset to process

   ApproachName : name of a field in Options.approaches that determines which approach to use

   DatasetNames : names of the respective datasets for diagnostics
   
 Out:
   Results : result data structure

 See also:
   bci_batchtrain

                                Christian Kothe, Swartz Center for Computational Neuroscience, UCSD
                                2011-08-19</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">

</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">

</ul>
<!-- crossreference -->


<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">

<li><a href="#_sub1" class="code">function results = do_run(opts,d,appname,setnames)</a></li>
</ul>




<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function results = utl_run_batchjob(opts,d,appname,setnames)</a>
0002 <span class="comment">% Internal: the actual processing function of bci_batchtrain.</span>
0003 <span class="comment">% Results = ult_run_batchjob(Options,DatasetIndex,ApproachName,DatasetNames)</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This function executes one of the individual jobs generated by bci_batchtrain (application of one</span>
0006 <span class="comment">% approach to one dataset).</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% In:</span>
0009 <span class="comment">%   Options : bci_batchtrain options struct</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%   DatasetIndex : index into Options.datasets that determines which dataset to process</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%   ApproachName : name of a field in Options.approaches that determines which approach to use</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%   DatasetNames : names of the respective datasets for diagnostics</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Out:</span>
0018 <span class="comment">%   Results : result data structure</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% See also:</span>
0021 <span class="comment">%   bci_batchtrain</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%                                Christian Kothe, Swartz Center for Computational Neuroscience, UCSD</span>
0024 <span class="comment">%                                2011-08-19</span>
0025 dp;
0026 
0027 <span class="comment">% scaffolding to support custom error handlers (ultimately calls do_run to do the actual work)</span>
0028 results = [];
0029 <span class="keyword">if</span> strcmp(char(opts.handler),<span class="string">'rethrow'</span>)
0030     results = <a href="#_sub1" class="code" title="subfunction results = do_run(opts,d,appname,setnames)">do_run</a>(opts,d,appname,setnames);
0031 <span class="keyword">else</span>
0032     <span class="keyword">try</span>
0033         results = <a href="#_sub1" class="code" title="subfunction results = do_run(opts,d,appname,setnames)">do_run</a>(opts,d,appname,setnames);
0034     <span class="keyword">catch</span> e
0035         fprintf(<span class="string">'Error processing data set &quot;%s&quot; with approach &quot;%s&quot;.'</span>,setnames{d},appname);
0036         <span class="keyword">if</span> ischar(opts.handler)
0037             <span class="keyword">try</span>
0038                 opts.handler = str2func(opts.handler); 
0039             <span class="keyword">catch</span> e
0040                 error(<span class="string">'The given error handler is malformed: %s'</span>,hlp_tostring(opts.handler,100));
0041             <span class="keyword">end</span>
0042         <span class="keyword">end</span>
0043         opts.handler(e);
0044     <span class="keyword">end</span>
0045 <span class="keyword">end</span>
0046 
0047 <a name="_sub1" href="#_subfunctions" class="code">function results = do_run(opts,d,appname,setnames)</a>
0048     <span class="comment">% run a particular approach on a particular data set</span>
0049     results = [];    
0050     
0051     <span class="comment">% determine where results would be saved</span>
0052     storename = env_translatepath(strrep(strrep(opts.storepatt,<span class="string">'%set'</span>,setnames{d}),<span class="string">'%approach'</span>,appname));    
0053     <span class="keyword">if</span> opts.reuse &amp;&amp; ~isempty(storename) &amp;&amp; exist(storename,<span class="string">'file'</span>)
0054         
0055         <span class="comment">% attempt to load existing results from disk</span>
0056         fprintf(<span class="string">'Reusing existing result for approach &quot;%s&quot; on set &quot;%s&quot;.\n'</span>,appname,setnames{d});
0057         t0=tic; fprintf(<span class="string">'Trying to load file %s...'</span>,storename);
0058         <span class="keyword">if</span> opts.cache_loaded
0059             <span class="keyword">persistent</span> result_cache; <span class="comment">%#ok&lt;TLEV&gt;</span>
0060             storetag = [<span class="string">'x'</span> hlp_cryptohash(storename)];
0061             <span class="keyword">if</span> isfield(result_cache,storetag)
0062                 res = result_cache.(storetag);
0063             <span class="keyword">else</span>
0064                 io_load(storename);
0065                 result_cache.(storetag) = res; <span class="comment">%#ok&lt;NODEF&gt;</span>
0066             <span class="keyword">end</span>
0067         <span class="keyword">else</span>
0068             io_load(storename);
0069         <span class="keyword">end</span>
0070         fprintf(<span class="string">'%.1f seconds (%.1f MB/s).\n'</span>,toc(t0),getfield(whos(<span class="string">'res'</span>),<span class="string">'bytes'</span>)/2^20/toc(t0));
0071         
0072     <span class="keyword">elseif</span> ~opts.loadonly
0073         
0074         <span class="comment">% train a model on the Dataset using bci_train</span>
0075         [res.loss,res.model,res.stats] = bci_train(opts.trainargs{:}, <span class="string">'data'</span>,opts.datasets{d}, <span class="string">'approach'</span>,opts.approaches.(appname), <span class="string">'markers'</span>,opts.markers);
0076         
0077         <span class="comment">% optionally run bci_predict on each of the PredictSets</span>
0078         <span class="keyword">if</span> ~isempty(opts.predictsets) &amp;&amp; ~isempty(opts.predictsets{d})
0079             <span class="keyword">for</span> k=1:length(opts.predictsets{d})
0080                 <span class="keyword">try</span>
0081                     [res.pred_predictions{k},res.pred_loss(k),res.pred_stats{k},res.pred_targets{k}] = bci_predict(opts.predictargs{:},<span class="string">'data'</span>,opts.predictsets{d}{k},<span class="string">'model'</span>,res.model, <span class="string">'markers'</span>,opts.markers);
0082                 <span class="keyword">catch</span> e
0083                     [res.pred_predictions{k},res.pred_loss(k),res.pred_stats{k},res.pred_targets{k}] = deal([],NaN,struct(),[]);
0084                     fprintf(<span class="string">'Error computing predictions for set &quot;%s&quot;, prediction set #%i with approach &quot;%s&quot;.\n'</span>,setnames{d},k,appname);
0085                     opts.handler(e);
0086                 <span class="keyword">end</span>
0087             <span class="keyword">end</span>
0088             res.pred_loss = res.pred_loss';
0089         <span class="keyword">end</span>
0090             
0091         <span class="comment">% save results</span>
0092         <span class="keyword">if</span> ~isempty(storename)
0093             t0=tic; fprintf(<span class="string">'Saving results as %s...'</span>,storename);
0094             io_save(storename,opts.saveargs{:},<span class="string">'res'</span>); 
0095             fprintf(<span class="string">'%.1f seconds (%.1f MB/s).\n'</span>,toc(t0),getfield(whos(<span class="string">'res'</span>),<span class="string">'bytes'</span>)/2^20/toc(t0));
0096         <span class="keyword">end</span>
0097     <span class="keyword">end</span>
0098     
0099     <span class="comment">% assign results to result data structure</span>
0100     <span class="keyword">if</span> ~isempty(opts.resultpatt)
0101         <span class="keyword">try</span>
0102             statement = [strrep(strrep(opts.resultpatt,<span class="string">'%num'</span>,num2str(d)),<span class="string">'%approach'</span>,appname) <span class="string">' res;'</span>];
0103             eval(statement); 
0104         <span class="keyword">catch</span> e
0105             fprintf(<span class="string">'Failed to evaluate ResultPattern (statement was &quot;%s&quot;) with error: %s.\n'</span>,statement,e.message);
0106         <span class="keyword">end</span>        
0107     <span class="keyword">end</span>
0108     
0109     <span class="comment">% print diagnostics</span>
0110     <span class="keyword">try</span>
0111         <span class="keyword">if</span> isfield(res,<span class="string">'pred_loss'</span>)
0112             fprintf(<span class="string">'%s@%s: train loss: %.4f, prediction loss: %.4f\n'</span>,appname,setnames{d},res.loss,res.pred_loss);
0113         <span class="keyword">else</span>
0114             fprintf(<span class="string">'%s@%s: train loss: %.4f\n'</span>,appname,setnames{d},res.loss);
0115         <span class="keyword">end</span>
0116     <span class="keyword">catch</span> e
0117         fprintf(<span class="string">'Failed to display loss estimates with error: %s\n'</span>,e.message);
0118     <span class="keyword">end</span></pre></div>

<hr><address>Generated on Wed 19-Aug-2015 18:06:23 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>